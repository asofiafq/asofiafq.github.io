<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Energy Digital Twin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            margin: 0;
            background: #0a0f24;
            font-family: Arial, sans-serif;
            color: white;
            transition: 0.3s;
        }

        body.light {
            background: #f4f6fc;
            color: black;
        }

        h1 {
            text-align: center;
            margin-top: 25px;
            font-size: 40px;
            color: #4db8ff;
            text-shadow: 0px 0px 12px #4db8ff;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .card {
            background: rgba(255,255,255,0.07);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0px 0px 15px rgba(0,0,0,0.4);
            transition: 0.3s;
        }
        .light .card {
            background: rgba(0,0,0,0.08);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            background: #4db8ff;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
        }

        .toggle-btn {
            float: right;
            margin: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>

<button class="btn toggle-btn" onclick="toggleMode()">Toggle Light/Dark</button>

<h1>âš¡ Advanced Community Energy Digital Twin Dashboard</h1>

<div class="grid">
    <!-- CATEGORY CHART -->
    <div class="card">
        <h2>Category Load Curves</h2>
        <canvas id="categoryChart"></canvas>
    </div>

    <!-- CONTROL PANEL -->
    <div class="card">
        <h2>Microgrid Controls</h2>

        <p>Battery Size (MWh): <span id="battLabel">4</span></p>
        <input id="battSlider" type="range" min="1" max="10" value="4">

        <p>Weather (Solar Factor): <span id="weatherLabel">1.0</span></p>
        <input id="weatherSlider" type="range" min="0.2" max="1.0" step="0.1" value="1">

        <p>Demand Level: <span id="demandLabel">1.0</span></p>
        <input id="demandSlider" type="range" min="0.5" max="1.5" step="0.1" value="1">

        <p>Simulate Outage:</p>
        <button class="btn" onclick="simulateOutage()">Run Outage Simulation</button>

        <p class="status" id="statusBox">ðŸŸ¢ Microgrid Stable</p>

        <button class="btn" onclick="generatePDF()">Export Scenario as PDF</button>
    </div>

    <!-- SOLAR VS DEMAND -->
    <div class="card">
        <h2>Solar vs Demand</h2>
        <canvas id="solarChart"></canvas>
    </div>

    <!-- BATTERY -->
    <div class="card">
        <h2>Battery Level</h2>
        <canvas id="batteryChart"></canvas>
    </div>

    <!-- CATEGORY CONTRIBUTION CHART -->
    <div class="card">
        <h2>Category Contribution Breakdown</h2>
        <canvas id="stackChart"></canvas>
    </div>

    <!-- EMISSIONS + COST -->
    <div class="card">
        <h2>Environmental & Economic Impact</h2>
        <p>COâ‚‚ Avoided: <span id="co2Value">0</span> kg</p>
        <p>Cost Savings: $<span id="costValue">0</span></p>
    </div>
</div>

<script>
/* -----------------------------------------------------
   1. USE YOUR CATEGORY DATA (EXPANDED)
----------------------------------------------------- */
const labels = Array.from({length: 100}, (_, i) => i * 15 + " min");

// YOUR categories from screenshot (25 points each)
const categories = {
    "Hospital": [350,360,370,400,420,500,600,720,800,820,840,900,950,970,980,1000,1040,1100,1150,1180,1200,1220,1250,1300,1350],
    "Medical Clinic": [100,110,130,150,170,190,210,230,260,280,300,320,330,340,350,360,380,390,400,420,440,450,460,470,480],
    "K12 School": [80,90,120,150,200,300,350,380,400,420,430,420,400,350,300,250,200,150,120,100,90,80,70,60,50],
    "Grocery Store": [200,220,240,260,280,300,350,400,450,500,520,530,540,550,560,570,580,590,600,610,620,630,640,650,660],
    "Post Office": [40,45,50,55,60,70,80,100,120,130,140,150,160,160,150,140,130,120,110,100,90,80,70,60,50],
    "College Campus": [150,160,200,250,300,350,400,450,500,520,540,550,540,530,520,510,480,460,440,420,390,360,330,300,250],
    "Warehouse": [120,130,140,150,160,170,180,190,200,220,240,260,270,280,290,300,310,300,290,280,260,250,240,230,220],
    "Police Station": [60,70,80,100,120,150,200,240,260,280,300,310,320,320,310,300,290,280,260,240,220,200,180,160,140],
    "Fire Station": [50,60,70,90,110,150,180,210,230,250,260,270,280,290,300,310,300,290,280,260,240,220,200,180,160],
    "Gas Station": [100,120,140,160,180,200,250,300,360,400,420,440,460,480,500,520,540,560,580,600,620,640,660,680,700]
};

function expand(data) {
    const expanded = [];
    for (let i = 0; i < data.length - 1; i++) {
        const s = data[i], e = data[i+1];
        for (let j = 0; j < 4; j++) expanded.push(s + (e - s) * (j/4));
    }
    return expanded.slice(0,100);
}

const expandedCategories = {};
for (const key in categories) {
    expandedCategories[key] = expand(categories[key]);
}

/* -----------------------------------------------------
   2. CATEGORY CHART
----------------------------------------------------- */
const categoryChart = new Chart(
    document.getElementById("categoryChart"),
    {
        type: "line",
        data: {
            labels,
            datasets: Object.keys(expandedCategories).map((cat, i) => ({
                label: cat,
                data: expandedCategories[cat],
                borderWidth: 2,
                borderColor: `hsl(${i*36},100%,60%)`,
                fill: false
            }))
        }
    }
);

/* -----------------------------------------------------
   3. DEMAND, SOLAR, BATTERY
----------------------------------------------------- */
function computeTotalDemand(scale) {
    return labels.map((_, idx) =>
        Object.values(expandedCategories)
            .reduce((a,b)=>a+b[idx],0) * scale
    );
}

function computeSolar(weather) {
    return labels.map((_,i)=>{
        const x = Math.sin((i/labels.length)*Math.PI);
        return Math.max(0,x) * 900 * weather;
    });
}

function computeBattery(demand, solar, capMWh) {
    let cap = capMWh * 1000;
    let level = 0;
    let out = [];
    for (let i=0;i<demand.length;i++) {
        level += (solar[i] - demand[i]) * 0.25;
        if (level > cap) level = cap;
        if (level < 0) level = 0;
        out.push(level);
    }
    return out;
}

/* -----------------------------------------------------
   4. CHARTS
----------------------------------------------------- */
const solarChart = new Chart(
    document.getElementById("solarChart"),
    {
        type:"line",
        data:{
            labels,
            datasets:[
                {label:"Total Demand", borderColor:"#ff6961", data:[]},
                {label:"Solar Output", borderColor:"#77dd77", data:[]}
            ]
        }
    }
);

const batteryChart = new Chart(
    document.getElementById("batteryChart"),
    {
        type:"line",
        data:{
            labels,
            datasets:[{label:"Battery Level", borderColor:"#4db8ff", data:[]}]
        }
    }
);

/* -----------------------------------------------------
   5. CATEGORY STACKED CHART (BREAKDOWN)
----------------------------------------------------- */
const stackChart = new Chart(
    document.getElementById("stackChart"),
    {
        type:"bar",
        data:{
            labels: Object.keys(expandedCategories),
            datasets:[{
                label: "Peak kW",
                data:Object.values(expandedCategories).map(arr=>Math.max(...arr)),
                backgroundColor:Object.keys(expandedCategories)
                    .map((_,i)=>`hsl(${i*36},100%,60%)`)
            }]
        }
    }
);

/* -----------------------------------------------------
   6. UPDATE FUNCTION FOR SLIDERS
----------------------------------------------------- */
function updateAll() {
    const batt = Number(battSlider.value);
    const weather = Number(weatherSlider.value);
    const demandScale = Number(demandSlider.value);

    battLabel.textContent = batt;
    weatherLabel.textContent = weather;
    demandLabel.textContent = demandScale;

    const demand = computeTotalDemand(demandScale);
    const solar = computeSolar(weather);
    const battery = computeBattery(demand, solar, batt);

    solarChart.data.datasets[0].data = demand;
    solarChart.data.datasets[1].data = solar;
    solarChart.update();

    batteryChart.data.datasets[0].data = battery;
    batteryChart.update();

    computeImpact(demand, solar);
}

/* -----------------------------------------------------
   7. OUTAGE SIMULATION
----------------------------------------------------- */
function simulateOutage() {
    const demand = solarChart.data.datasets[0].data;
    const battery = batteryChart.data.datasets[0].data;
    const status = document.getElementById("statusBox");

    let hoursPowered = 0;
    for (let i=0;i<battery.length;i++) {
        if (battery[i] > 0) hoursPowered += 0.25;
    }

    if (hoursPowered >= 12) {
        status.textContent = "ðŸŸ¢ Microgrid Stable: " + hoursPowered.toFixed(1) + " hours";
        status.style.background = "#145214";
    } else if (hoursPowered >= 4) {
        status.textContent = "ðŸŸ¡ Strained: " + hoursPowered.toFixed(1) + " hours";
        status.style.background = "#665200";
    } else {
        status.textContent = "ðŸ”´ Critical: Only "+hoursPowered.toFixed(1)+" hours";
        status.style.background = "#6b0000";
    }
}

/* -----------------------------------------------------
   8. EMISSIONS + COST SAVINGS
----------------------------------------------------- */
function computeImpact(demand, solar) {
    let solarUsed = solar.reduce((a,b)=>a+b,0);
    let demandTotal = demand.reduce((a,b)=>a+b,0);

    let co2Avoided = solarUsed * 0.42; // kg COâ‚‚/kWh avoided
    let costSaved = solarUsed * 0.12; // $ per kWh

    document.getElementById("co2Value").textContent = co2Avoided.toFixed(1);
    document.getElementById("costValue").textContent = costSaved.toFixed(2);
}

/* -----------------------------------------------------
   9. EXPORT TO PDF
----------------------------------------------------- */
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text("Energy Digital Twin Report", 10, 10);
    doc.text("Battery Size: " + battLabel.textContent + " MWh", 10, 20);
    doc.text("Weather Factor: " + weatherLabel.textContent, 10, 30);
    doc.text("Demand Level: " + demandLabel.textContent, 10, 40);

    doc.text("COâ‚‚ Avoided: " + document.getElementById("co2Value").textContent + " kg", 10, 60);
    doc.text("Cost Savings: $" + document.getElementById("costValue").textContent, 10, 70);

    doc.save("energy_report.pdf");
}

/* -----------------------------------------------------
   10. LIGHT/DARK MODE
----------------------------------------------------- */
function toggleMode() {
    document.body.classList.toggle("light");
}

battSlider.oninput = weatherSlider.oninput = demandSlider.oninput = updateAll;

/* Initial load */
updateAll();

</script>
</body>
</html>
